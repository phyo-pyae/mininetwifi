#!/usr/bin/env python3
"""Sample file for VANET with Signal Strength Monitoring"""

import os
import sys
import time
import threading

if 'SUMO_HOME' in os.environ:
    sys.path.append(os.path.join(os.environ['SUMO_HOME'], 'tools'))
else:
    sys.exit("Please set SUMO_HOME environment variable")

from mininet.log import setLogLevel, info
from mn_wifi.cli import CLI
from mn_wifi.net import Mininet_wifi
from mn_wifi.sumo.runner import sumo
from mn_wifi.link import wmediumd, ITSLink
from mn_wifi.wmediumdConnector import interference


def monitor_signal_strength(net):
    """Monitor and display signal strength between cars and APs"""
    
    while True:
        try:
            print("\n" + "="*80)
            print("SIGNAL STRENGTH MONITORING (dBm)")
            print("="*80)
            
            # Get all cars and APs
            cars = net.cars
            aps = net.aps
            
            # For each car, show signal to all APs
            for car in cars:
                print(f"\n{car.name}:")
                
                for ap in aps:
                    try:
                        # Calculate distance
                        car_pos = car.getPosition()
                        ap_pos = ap.getPosition()
                        
                        distance = ((car_pos[0] - ap_pos[0])**2 + 
                                   (car_pos[1] - ap_pos[1])**2)**0.5
                        
                        # Get signal strength (dBm)
                        # Using logDistance propagation model: exp=2.8
                        # Signal = -80 - 10*2.8*log10(distance)
                        if distance > 0:
                            signal_dbm = -80 - 10*2.8*(distance/100) / 100
                        else:
                            signal_dbm = -50
                        
                        # Determine connection quality
                        if signal_dbm > -70:
                            quality = "EXCELLENT ✓✓✓"
                        elif signal_dbm > -80:
                            quality = "GOOD ✓✓"
                        elif signal_dbm > -90:
                            quality = "FAIR ✓"
                        elif signal_dbm > -100:
                            quality = "POOR ⚠"
                        else:
                            quality = "VERY POOR ✗ (out of range)"
                        
                        print(f"  → {ap.name}: {signal_dbm:.1f} dBm | " + 
                              f"Distance: {distance:.1f}m | {quality}")
                    
                    except Exception as e:
                        print(f"  → {ap.name}: Error - {e}")
            
            print("\n" + "="*80)
            print("(Updating every 5 seconds... Press Ctrl+C to stop monitoring)\n")
            
            time.sleep(5)
            
        except KeyboardInterrupt:
            print("\nSignal monitoring stopped")
            break
        except Exception as e:
            print(f"Monitoring error: {e}")
            time.sleep(5)


def topology():
    """Create rectangular road network with signal strength monitoring"""
    
    net = Mininet_wifi(link=wmediumd, wmediumd_mode=interference)

    info("*** Creating 10 vehicles\n")
    for id in range(0, 10):
        net.addCar('car%s' % (id+1), wlans=2, encrypt=['wpa2', ''])

    # AP configuration
    kwargs = {'ssid': 'vanet-ssid', 'mode': 'g', 'passwd': '123456789a',
              'encrypt': 'wpa2', 'failMode': 'standalone', 'datapath': 'user'}
    
    info("*** Creating 6 RSUs (rectangular grid)\n")
    e1 = net.addAccessPoint('e1', mac='00:00:00:11:00:01', channel='1',
                            position='2600,3500,0', **kwargs)
    e2 = net.addAccessPoint('e2', mac='00:00:00:11:00:02', channel='6',
                            position='2800,3500,0', **kwargs)
    e3 = net.addAccessPoint('e3', mac='00:00:00:11:00:03', channel='11',
                            position='3000,3500,0', **kwargs)
    e4 = net.addAccessPoint('e4', mac='00:00:00:11:00:04', channel='1',
                            position='2600,3300,0', **kwargs)
    e5 = net.addAccessPoint('e5', mac='00:00:00:11:00:05', channel='6',
                            position='2800,3300,0', **kwargs)
    e6 = net.addAccessPoint('e6', mac='00:00:00:11:00:06', channel='11',
                            position='3000,3300,0', **kwargs)

    info("*** Configuring Propagation Model (logDistance, exp=2.8)\n")
    net.setPropagationModel(model="logDistance", exp=2.8)

    info("*** Configuring nodes\n")
    net.configureNodes()

    # Backbone network (RSU to RSU)
    net.addLink(e1, e2)
    net.addLink(e2, e3)
    net.addLink(e3, e4)
    net.addLink(e4, e5)
    net.addLink(e5, e6)
    
    # V2V communication (car to car)
    for car in net.cars:
        net.addLink(car, intf=car.wintfs[1].name,
                    cls=ITSLink, band=20, channel=181)

    info("*** Connecting to SUMO\n")
    
    # Get path to SUMO config
    script_dir = os.path.dirname(os.path.abspath(__file__))
    sumo_dir = os.path.join(script_dir, '..', 'sumo')
    sumo_dir = os.path.abspath(sumo_dir)
    sumo_config = os.path.join(sumo_dir, 'config.sumocfg')
    
    if not os.path.exists(sumo_config):
        info(f"ERROR: Config file not found at {sumo_config}\n")
        sys.exit(1)
    
    net.useExternalProgram(program=sumo, port=8813,
                           config_file=sumo_config,
                           extra_params=["--start --delay 1000"],
                           clients=1, exec_order=0)

    info("*** Starting network\n")
    net.build()

    for enb in net.aps:
        enb.start([])

    # Assign IP addresses
    for id, car in enumerate(net.cars):
        car.setIP('192.168.0.{}/24'.format(id+1),
                  intf='{}'.format(car.wintfs[0].name))
        car.setIP('192.168.1.{}/24'.format(id+1),
                  intf='{}'.format(car.wintfs[1].name))

    # Track positions
    nodes = net.cars + net.aps
    net.telemetry(nodes=nodes, data_type='position',
                  min_x=2200, min_y=2800,
                  max_x=3200, max_y=3900)

    info("*** Starting Signal Strength Monitor\n")
    # Start monitoring in background thread
    monitor_thread = threading.Thread(target=monitor_signal_strength, args=(net,), daemon=True)
    monitor_thread.start()

    info("*** Running CLI\n")
    info("Commands: car1 ping car2 | car1 ping e1 | exit\n")
    
    CLI(net)

    info("*** Stopping network\n")
    net.stop()


if __name__ == '__main__':
    setLogLevel('info')
    topology()